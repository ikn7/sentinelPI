#!/bin/bash
# sentinelctl - Script de gestion de SentinelPi
#
# Usage: sentinelctl <commande> [options]
#
# Commandes:
#   start       D√©marrer tous les services
#   stop        Arr√™ter tous les services
#   restart     Red√©marrer tous les services
#   status      Afficher le statut
#   logs        Afficher les logs
#   config      √âditer la configuration
#   backup      Sauvegarder les donn√©es
#   restore     Restaurer une sauvegarde
#   update      Mettre √† jour SentinelPi

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

CONFIG_DIR="/etc/sentinelpi"
DATA_DIR="/var/lib/sentinelpi"
LOG_DIR="/var/log/sentinelpi"
INSTALL_DIR="/opt/sentinelpi"
BACKUP_DIR="/var/backups/sentinelpi"

print_header() {
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BLUE}       SentinelPi - Station de Veille${NC}"
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
}

cmd_start() {
    echo -e "${GREEN}‚ñ∂ D√©marrage des services...${NC}"
    sudo systemctl start sentinelpi
    sudo systemctl start sentinelpi-dashboard
    echo -e "${GREEN}‚úì Services d√©marr√©s${NC}"
    cmd_status
}

cmd_stop() {
    echo -e "${YELLOW}‚ñ† Arr√™t des services...${NC}"
    sudo systemctl stop sentinelpi-dashboard 2>/dev/null || true
    sudo systemctl stop sentinelpi 2>/dev/null || true
    echo -e "${YELLOW}‚úì Services arr√™t√©s${NC}"
}

cmd_restart() {
    echo -e "${YELLOW}‚Üª Red√©marrage des services...${NC}"
    sudo systemctl restart sentinelpi
    sudo systemctl restart sentinelpi-dashboard
    echo -e "${GREEN}‚úì Services red√©marr√©s${NC}"
    cmd_status
}

cmd_status() {
    print_header
    echo ""

    # Service principal
    if systemctl is-active --quiet sentinelpi; then
        echo -e "  Collecteur:  ${GREEN}‚óè Actif${NC}"
    else
        echo -e "  Collecteur:  ${RED}‚óã Inactif${NC}"
    fi

    # Dashboard
    if systemctl is-active --quiet sentinelpi-dashboard; then
        echo -e "  Dashboard:   ${GREEN}‚óè Actif${NC} (http://localhost:8501)"
    else
        echo -e "  Dashboard:   ${RED}‚óã Inactif${NC}"
    fi

    echo ""

    # Stats rapides
    if [ -f "$DATA_DIR/sentinelpi.db" ]; then
        ITEMS=$(sqlite3 "$DATA_DIR/sentinelpi.db" "SELECT COUNT(*) FROM items;" 2>/dev/null || echo "0")
        SOURCES=$(sqlite3 "$DATA_DIR/sentinelpi.db" "SELECT COUNT(*) FROM sources WHERE enabled=1;" 2>/dev/null || echo "0")
        ALERTS=$(sqlite3 "$DATA_DIR/sentinelpi.db" "SELECT COUNT(*) FROM alerts WHERE acknowledged_at IS NULL;" 2>/dev/null || echo "0")

        echo -e "  üìä Stats:"
        echo -e "     Sources actives: $SOURCES"
        echo -e "     Items collect√©s: $ITEMS"
        echo -e "     Alertes non lues: $ALERTS"
    fi

    echo ""
}

cmd_logs() {
    SERVICE="${2:-sentinelpi}"
    LINES="${3:-50}"

    echo -e "${BLUE}üìã Logs de $SERVICE (${LINES} derni√®res lignes)${NC}"
    echo ""

    if [ "$SERVICE" = "all" ]; then
        echo -e "${YELLOW}=== sentinelpi ===${NC}"
        journalctl -u sentinelpi -n "$LINES" --no-pager
        echo ""
        echo -e "${YELLOW}=== sentinelpi-dashboard ===${NC}"
        journalctl -u sentinelpi-dashboard -n "$LINES" --no-pager
    else
        journalctl -u "$SERVICE" -n "$LINES" --no-pager
    fi
}

cmd_logs_follow() {
    SERVICE="${2:-sentinelpi}"
    echo -e "${BLUE}üìã Logs en temps r√©el de $SERVICE (Ctrl+C pour quitter)${NC}"
    journalctl -u "$SERVICE" -f
}

cmd_config() {
    FILE="${2:-settings}"

    case "$FILE" in
        settings|s)
            sudo nano "$CONFIG_DIR/settings.yaml"
            ;;
        sources|src)
            sudo nano "$CONFIG_DIR/sources.yaml"
            ;;
        filters|f)
            sudo nano "$CONFIG_DIR/filters.yaml"
            ;;
        alerts|a)
            sudo nano "$CONFIG_DIR/alerts.yaml"
            ;;
        env|e)
            sudo nano "$CONFIG_DIR/.env"
            ;;
        *)
            echo "Usage: sentinelctl config [settings|sources|filters|alerts|env]"
            exit 1
            ;;
    esac

    echo -e "${YELLOW}Configuration modifi√©e. Red√©marrer les services ? (o/n)${NC}"
    read -r answer
    if [ "$answer" = "o" ] || [ "$answer" = "O" ]; then
        cmd_restart
    fi
}

cmd_backup() {
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="$BACKUP_DIR/sentinelpi_backup_$TIMESTAMP.tar.gz"

    echo -e "${BLUE}üíæ Cr√©ation de la sauvegarde...${NC}"

    sudo mkdir -p "$BACKUP_DIR"

    # Arr√™ter les services pour une sauvegarde coh√©rente
    echo "  Arr√™t temporaire des services..."
    sudo systemctl stop sentinelpi 2>/dev/null || true

    # Cr√©er l'archive
    echo "  Archivage..."
    sudo tar -czf "$BACKUP_FILE" \
        -C / \
        "etc/sentinelpi" \
        "var/lib/sentinelpi"

    # Red√©marrer
    echo "  Red√©marrage des services..."
    sudo systemctl start sentinelpi 2>/dev/null || true

    SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    echo ""
    echo -e "${GREEN}‚úì Sauvegarde cr√©√©e: $BACKUP_FILE ($SIZE)${NC}"
}

cmd_restore() {
    BACKUP_FILE="$2"

    if [ -z "$BACKUP_FILE" ]; then
        echo "Sauvegardes disponibles:"
        ls -lh "$BACKUP_DIR"/*.tar.gz 2>/dev/null || echo "  Aucune sauvegarde trouv√©e"
        echo ""
        echo "Usage: sentinelctl restore <fichier.tar.gz>"
        exit 1
    fi

    if [ ! -f "$BACKUP_FILE" ]; then
        echo -e "${RED}Erreur: Fichier non trouv√©: $BACKUP_FILE${NC}"
        exit 1
    fi

    echo -e "${YELLOW}‚ö† Cette op√©ration va remplacer toutes les donn√©es actuelles.${NC}"
    echo -e "${YELLOW}Continuer ? (oui/non)${NC}"
    read -r answer

    if [ "$answer" != "oui" ]; then
        echo "Annul√©."
        exit 0
    fi

    echo -e "${BLUE}üì• Restauration...${NC}"

    # Arr√™ter les services
    cmd_stop

    # Restaurer
    sudo tar -xzf "$BACKUP_FILE" -C /

    # Red√©marrer
    cmd_start

    echo -e "${GREEN}‚úì Restauration termin√©e${NC}"
}

cmd_update() {
    echo -e "${BLUE}üîÑ Mise √† jour de SentinelPi...${NC}"

    # Arr√™ter les services
    cmd_stop

    # Mettre √† jour
    cd "$INSTALL_DIR"
    sudo -u sentinelpi git pull origin main 2>/dev/null || echo "  (pas de mise √† jour git)"
    sudo "$INSTALL_DIR/venv/bin/pip" install -e . --quiet

    # Red√©marrer
    cmd_start

    echo -e "${GREEN}‚úì Mise √† jour termin√©e${NC}"
}

cmd_help() {
    print_header
    echo ""
    echo "Usage: sentinelctl <commande> [options]"
    echo ""
    echo "Commandes:"
    echo "  start           D√©marrer tous les services"
    echo "  stop            Arr√™ter tous les services"
    echo "  restart         Red√©marrer tous les services"
    echo "  status          Afficher le statut"
    echo "  logs [service]  Afficher les logs (sentinelpi, sentinelpi-dashboard, all)"
    echo "  logs-f [service] Suivre les logs en temps r√©el"
    echo "  config [fichier] √âditer la configuration (settings, sources, filters, alerts, env)"
    echo "  backup          Sauvegarder les donn√©es"
    echo "  restore <file>  Restaurer une sauvegarde"
    echo "  update          Mettre √† jour SentinelPi"
    echo "  help            Afficher cette aide"
    echo ""
    echo "Exemples:"
    echo "  sentinelctl status"
    echo "  sentinelctl logs-f sentinelpi"
    echo "  sentinelctl config sources"
    echo "  sentinelctl backup"
    echo ""
}

# Main
case "${1:-status}" in
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    logs)
        cmd_logs "$@"
        ;;
    logs-f|follow)
        cmd_logs_follow "$@"
        ;;
    config|edit)
        cmd_config "$@"
        ;;
    backup)
        cmd_backup
        ;;
    restore)
        cmd_restore "$@"
        ;;
    update)
        cmd_update
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        echo -e "${RED}Commande inconnue: $1${NC}"
        echo "Utilisez 'sentinelctl help' pour voir les commandes disponibles."
        exit 1
        ;;
esac
