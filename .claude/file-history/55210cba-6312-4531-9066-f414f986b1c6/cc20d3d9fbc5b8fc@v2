"""Tests pour le système de configuration."""

import os
import tempfile
from pathlib import Path

import pytest
import yaml


class TestSettings:
    """Tests pour la classe Settings."""

    def test_default_settings(self):
        """Test des valeurs par défaut."""
        # Import ici pour éviter le chargement prématuré
        from src.config import Settings

        settings = Settings()

        assert settings.app.name == "StratWatch"
        assert settings.app.version == "1.0.0"
        assert settings.database.type == "sqlite"
        assert settings.api.port == 8000
        assert settings.dashboard.port == 8501

    def test_yaml_config_loading(self, tmp_path):
        """Test du chargement de configuration YAML."""
        from src.config import Settings, CONFIG_DIR

        # Vérifier que le fichier YAML existe
        config_path = CONFIG_DIR / "settings.yaml"
        if config_path.exists():
            settings = Settings()
            # Les valeurs du YAML devraient être chargées
            assert settings.app.timezone == "Europe/Paris"
            assert settings.collection.intervals.legal_data == 1440

    def test_database_url_sqlite(self):
        """Test de génération d'URL SQLite."""
        from src.config import Settings, PROJECT_ROOT

        settings = Settings()
        url = settings.get_database_url()

        assert url.startswith("sqlite+aiosqlite:///")
        assert "stratwatch.db" in url

    def test_env_var_override(self, monkeypatch):
        """Test de surcharge par variable d'environnement."""
        monkeypatch.setenv("PAPPERS_API_KEY", "test_key_123")
        monkeypatch.setenv("TELEGRAM_BOT_TOKEN", "bot_token_456")

        from src.config import reload_settings

        settings = reload_settings()

        assert settings.pappers_api_key == "test_key_123"
        assert settings.telegram_bot_token == "bot_token_456"
        assert settings.alerting.channels.telegram.bot_token == "bot_token_456"

    def test_data_dir_default(self):
        """Test du répertoire de données par défaut."""
        from src.config import Settings, DATA_DIR

        settings = Settings()
        data_dir = settings.get_data_dir()

        assert data_dir == DATA_DIR

    def test_log_dir_default(self):
        """Test du répertoire de logs par défaut."""
        from src.config import Settings, LOGS_DIR

        settings = Settings()
        log_dir = settings.get_log_dir()

        assert log_dir == LOGS_DIR


class TestCompetitorsConfig:
    """Tests pour la configuration des concurrents."""

    def test_load_competitors_empty(self, tmp_path, monkeypatch):
        """Test du chargement d'une liste vide de concurrents."""
        from src.config import load_competitors

        competitors_config = load_competitors()
        # La liste par défaut peut être vide
        assert isinstance(competitors_config.competitors, list)

    def test_competitor_model(self):
        """Test du modèle CompetitorConfig."""
        from src.config import CompetitorConfig

        competitor = CompetitorConfig(
            siren="123456789",
            nom="Test Company",
            priorite=1,
            site_web="https://example.com",
            mots_cles_presse=["Test", "Company"],
        )

        assert competitor.siren == "123456789"
        assert competitor.nom == "Test Company"
        assert competitor.priorite == 1
        assert len(competitor.mots_cles_presse) == 2


class TestSectorsConfig:
    """Tests pour la configuration des secteurs."""

    def test_load_sectors(self):
        """Test du chargement des secteurs."""
        from src.config import load_sectors

        sectors_config = load_sectors()
        assert isinstance(sectors_config.sectors, list)

    def test_sector_model(self):
        """Test du modèle SectorConfig."""
        from src.config import SectorConfig, AutoriteConfig

        sector = SectorConfig(
            id="tech",
            nom="Technologies",
            actif=True,
            mots_cles=["cloud", "IA"],
            autorites=[
                AutoriteConfig(nom="CNIL", url="https://cnil.fr")
            ],
        )

        assert sector.id == "tech"
        assert sector.actif is True
        assert len(sector.mots_cles) == 2
        assert len(sector.autorites) == 1
        assert sector.autorites[0].nom == "CNIL"


class TestCollectionConfig:
    """Tests pour la configuration de collecte."""

    def test_intervals(self):
        """Test des intervalles de collecte."""
        from src.config import Settings

        settings = Settings()

        assert settings.collection.intervals.legal_data == 1440
        assert settings.collection.intervals.job_offers == 360
        assert settings.collection.intervals.news == 60

    def test_rate_limits(self):
        """Test des limites de requêtes."""
        from src.config import Settings

        settings = Settings()

        assert settings.collection.rate_limits.default == 10
        assert settings.collection.rate_limits.pappers == 5

    def test_retry_config(self):
        """Test de la configuration de retry."""
        from src.config import Settings

        settings = Settings()

        assert settings.collection.retry.max_attempts == 3
        assert settings.collection.retry.base_delay == 5
        assert settings.collection.retry.max_delay == 60


class TestAlertingConfig:
    """Tests pour la configuration des alertes."""

    def test_telegram_config(self):
        """Test de la configuration Telegram."""
        from src.config import Settings

        settings = Settings()

        assert settings.alerting.channels.telegram.enabled is True
        assert settings.alerting.channels.telegram.min_severity == "attention"

    def test_alert_rules(self):
        """Test des règles d'alerte."""
        from src.config import Settings

        settings = Settings()

        assert settings.alerting.rules.recrutement_massif.threshold == 5
        assert settings.alerting.rules.recrutement_massif.period_days == 30
        assert settings.alerting.rules.echeance_proche.days_before == 30
        assert settings.alerting.rules.echeance_imminente.days_before == 7
