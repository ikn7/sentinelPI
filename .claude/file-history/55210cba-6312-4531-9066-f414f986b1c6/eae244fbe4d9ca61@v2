#!/bin/bash
# Script d'installation de StratWatch pour Raspberry Pi

set -e

echo "========================================"
echo "  Installation de StratWatch"
echo "========================================"
echo ""

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Fonction pour afficher les messages
info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# Vérifier si on est sur un Raspberry Pi
check_raspberry_pi() {
    if [ -f /proc/device-tree/model ]; then
        MODEL=$(cat /proc/device-tree/model)
        if [[ "$MODEL" == *"Raspberry Pi"* ]]; then
            info "Raspberry Pi détecté: $MODEL"
            return 0
        fi
    fi
    warn "Ce n'est pas un Raspberry Pi, mais l'installation continue..."
    return 0
}

# Vérifier Python
check_python() {
    if ! command -v python3 &> /dev/null; then
        error "Python 3 n'est pas installé"
    fi

    PYTHON_VERSION=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
    info "Python $PYTHON_VERSION détecté"

    # Vérifier la version minimale (3.11)
    if python3 -c 'import sys; exit(0 if sys.version_info >= (3, 11) else 1)'; then
        info "Version Python compatible"
    else
        error "Python 3.11 ou supérieur requis (version actuelle: $PYTHON_VERSION)"
    fi
}

# Installer les dépendances système
install_system_deps() {
    info "Installation des dépendances système..."

    sudo apt-get update

    # Dépendances pour WeasyPrint (génération PDF)
    sudo apt-get install -y \
        libpango-1.0-0 \
        libpangocairo-1.0-0 \
        libgdk-pixbuf2.0-0 \
        libffi-dev \
        shared-mime-info

    # Dépendances pour lxml
    sudo apt-get install -y \
        libxml2-dev \
        libxslt1-dev

    # Dépendances pour compilation Python
    sudo apt-get install -y \
        python3-dev \
        python3-pip \
        python3-venv

    info "Dépendances système installées"
}

# Créer l'environnement virtuel
create_venv() {
    VENV_DIR=".venv"

    if [ -d "$VENV_DIR" ]; then
        warn "Environnement virtuel existant détecté"
        read -p "Supprimer et recréer ? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -rf "$VENV_DIR"
        else
            info "Conservation de l'environnement existant"
            return 0
        fi
    fi

    info "Création de l'environnement virtuel..."
    python3 -m venv "$VENV_DIR"
    info "Environnement virtuel créé"
}

# Activer l'environnement et installer les dépendances Python
install_python_deps() {
    info "Activation de l'environnement virtuel..."
    source .venv/bin/activate

    info "Mise à jour de pip..."
    pip install --upgrade pip wheel setuptools

    info "Installation des dépendances Python..."
    pip install -r requirements.txt

    info "Installation du package en mode développement..."
    pip install -e .

    info "Dépendances Python installées"
}

# Installer spaCy et le modèle français (optionnel)
install_spacy() {
    read -p "Installer spaCy et le modèle français ? (recommandé pour NLP) (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        info "Installation de spaCy..."
        pip install spacy

        info "Téléchargement du modèle français..."
        python -m spacy download fr_core_news_md

        info "spaCy installé avec succès"
    else
        warn "spaCy non installé - fonctionnalités NLP désactivées"
    fi
}

# Créer les répertoires nécessaires
create_directories() {
    info "Création des répertoires..."
    mkdir -p data/{raw,processed,exports}
    mkdir -p logs
    info "Répertoires créés"
}

# Copier et configurer le fichier .env
setup_env() {
    if [ ! -f .env ]; then
        info "Création du fichier .env..."
        cp .env.example .env
        warn "N'oubliez pas de configurer vos clés API dans .env"
    else
        info "Fichier .env existant conservé"
    fi
}

# Initialiser la base de données
init_database() {
    info "Initialisation de la base de données..."
    source .venv/bin/activate
    python -c "
import asyncio
from src.storage import init_database
asyncio.run(init_database())
print('Base de données initialisée')
"
    info "Base de données prête"
}

# Afficher les instructions finales
show_instructions() {
    echo ""
    echo "========================================"
    echo "  Installation terminée !"
    echo "========================================"
    echo ""
    echo "Prochaines étapes:"
    echo ""
    echo "1. Configurez vos clés API dans .env:"
    echo "   nano .env"
    echo ""
    echo "2. Ajoutez vos concurrents dans config/competitors.yaml:"
    echo "   nano config/competitors.yaml"
    echo ""
    echo "3. Activez l'environnement virtuel:"
    echo "   source .venv/bin/activate"
    echo ""
    echo "4. Testez l'installation:"
    echo "   stratwatch config --check"
    echo ""
    echo "5. Lancez une première collecte:"
    echo "   stratwatch collect search \"votre entreprise\""
    echo ""
    echo "Documentation: README.md"
    echo ""
}

# Main
main() {
    cd "$(dirname "$0")/.."

    check_raspberry_pi
    check_python

    read -p "Installer les dépendances système ? (recommandé) (Y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        install_system_deps
    fi

    create_venv
    install_python_deps
    install_spacy
    create_directories
    setup_env
    init_database
    show_instructions
}

main "$@"
