"""Tests pour les notifications Telegram et Email."""

from datetime import datetime
from unittest.mock import AsyncMock, MagicMock, patch

import pytest

# Import des modules pour permettre le patching
import src.alerting.telegram
import src.alerting.email
import src.alerting.dispatcher


class TestTelegramNotifier:
    """Tests pour TelegramNotifier."""

    @pytest.fixture
    def mock_settings(self):
        """Mock des settings."""
        mock_settings = MagicMock()
        mock_settings.telegram_bot_token = "test_token"
        mock_settings.telegram_chat_id = "123456789"
        mock_settings.alerting.channels.telegram.enabled = True
        mock_settings.alerting.channels.telegram.min_severity = "info"

        with patch("src.alerting.telegram.get_settings", return_value=mock_settings):
            yield mock_settings

    @pytest.fixture
    def notifier(self, mock_settings):
        """Crée une instance du notifier."""
        from src.alerting.telegram import TelegramNotifier
        return TelegramNotifier()

    @pytest.fixture
    def sample_alert(self):
        """Crée une alerte de test."""
        from src.storage.models import Alert
        return Alert(
            id="alert-1",
            type="NOUVELLE_LOI",
            categorie="reglementaire",
            severite="attention",
            titre="Nouvelle loi sur les données",
            message="Une nouvelle loi a été publiée concernant la protection des données personnelles.",
            source_url="https://legifrance.gouv.fr/loi-123",
            created_at=datetime.now(),
        )

    def test_check_config_valid(self, notifier):
        """Test de configuration valide."""
        assert notifier._check_config() is True

    def test_check_config_disabled(self, mock_settings):
        """Test de configuration désactivée."""
        mock_settings.alerting.channels.telegram.enabled = False

        with patch("src.alerting.telegram.get_settings", return_value=mock_settings):
            from src.alerting.telegram import TelegramNotifier
            notifier = TelegramNotifier()
            assert notifier._check_config() is False

    def test_check_config_missing_token(self, mock_settings):
        """Test de configuration sans token."""
        mock_settings.telegram_bot_token = ""

        with patch("src.alerting.telegram.get_settings", return_value=mock_settings):
            from src.alerting.telegram import TelegramNotifier
            notifier = TelegramNotifier()
            assert notifier._check_config() is False

    def test_format_alert(self, notifier, sample_alert):
        """Test du formatage d'une alerte."""
        message = notifier._format_alert(sample_alert)

        assert "Nouvelle loi sur les données" in message
        assert "reglementaire" in message.lower() or "Reglementaire" in message
        assert "legifrance" in message

    def test_escape_markdown(self, notifier):
        """Test de l'échappement Markdown."""
        text = "Test *bold* and _italic_ with [link](url)"
        escaped = notifier._escape_markdown(text)

        assert "\\*" in escaped
        assert "\\_" in escaped
        assert "\\[" in escaped

    def test_should_send_above_threshold(self, notifier, sample_alert):
        """Test que l'alerte est envoyée si sévérité suffisante."""
        sample_alert.severite = "attention"
        assert notifier._should_send(sample_alert) is True

    def test_should_send_below_threshold(self, mock_settings):
        """Test que l'alerte n'est pas envoyée si sévérité insuffisante."""
        mock_settings.alerting.channels.telegram.min_severity = "important"

        with patch("src.alerting.telegram.get_settings", return_value=mock_settings):
            from src.alerting.telegram import TelegramNotifier
            from src.storage.models import Alert

            notifier = TelegramNotifier()
            alert = Alert(
                id="alert-1",
                type="TEST",
                categorie="test",
                severite="info",
                titre="Test",
                message="Test",
            )
            assert notifier._should_send(alert) is False


class TestEmailNotifier:
    """Tests pour EmailNotifier."""

    @pytest.fixture
    def mock_settings(self):
        """Mock des settings."""
        mock_settings = MagicMock()
        mock_settings.alerting.channels.email.enabled = True
        mock_settings.alerting.channels.email.smtp_host = "smtp.test.com"
        mock_settings.alerting.channels.email.smtp_port = 587
        mock_settings.alerting.channels.email.username = "user@test.com"
        mock_settings.alerting.channels.email.password = "password"
        mock_settings.alerting.channels.email.from_address = "stratwatch@test.com"
        mock_settings.alerting.channels.email.to_addresses = ["dest@test.com"]
        mock_settings.alerting.channels.email.min_severity = "info"

        with patch("src.alerting.email.get_settings", return_value=mock_settings):
            yield mock_settings

    @pytest.fixture
    def notifier(self, mock_settings):
        """Crée une instance du notifier."""
        from src.alerting.email import EmailNotifier
        return EmailNotifier()

    @pytest.fixture
    def sample_alert(self):
        """Crée une alerte de test."""
        from src.storage.models import Alert
        return Alert(
            id="alert-1",
            type="PROCEDURE_COLLECTIVE",
            categorie="concurrent",
            severite="critique",
            titre="Procédure collective détectée",
            message="Une procédure de redressement judiciaire a été ouverte.",
            source_url="https://bodacc.fr/annonce-123",
            created_at=datetime.now(),
        )

    def test_check_config_valid(self, notifier):
        """Test de configuration valide."""
        assert notifier._check_config() is True

    def test_check_config_disabled(self, mock_settings):
        """Test de configuration désactivée."""
        mock_settings.alerting.channels.email.enabled = False

        with patch("src.alerting.email.get_settings", return_value=mock_settings):
            from src.alerting.email import EmailNotifier
            notifier = EmailNotifier()
            assert notifier._check_config() is False

    def test_check_config_missing_smtp(self, mock_settings):
        """Test de configuration sans SMTP."""
        mock_settings.alerting.channels.email.smtp_host = ""

        with patch("src.alerting.email.get_settings", return_value=mock_settings):
            from src.alerting.email import EmailNotifier
            notifier = EmailNotifier()
            assert notifier._check_config() is False

    def test_format_alert_html(self, notifier, sample_alert):
        """Test du formatage HTML."""
        html = notifier._format_alert_html(sample_alert)

        assert "Procédure collective détectée" in html
        assert "#e74c3c" in html  # Couleur critique
        assert "CRITIQUE" in html
        assert "<html>" in html

    def test_format_alert_text(self, notifier, sample_alert):
        """Test du formatage texte."""
        text = notifier._format_alert_text(sample_alert)

        assert "[CRITIQUE]" in text
        assert "Procédure collective détectée" in text
        assert "redressement" in text

    def test_should_send_above_threshold(self, notifier, sample_alert):
        """Test que l'alerte est envoyée si sévérité suffisante."""
        assert notifier._should_send(sample_alert) is True


class TestNotificationDispatcher:
    """Tests pour NotificationDispatcher."""

    @pytest.fixture
    def mock_settings(self):
        """Mock des settings."""
        mock_settings = MagicMock()
        mock_settings.alerting.channels.telegram.enabled = True
        mock_settings.alerting.channels.email.enabled = True
        mock_settings.telegram_bot_token = "test_token"
        mock_settings.telegram_chat_id = "123456789"

        with patch("src.alerting.dispatcher.get_settings", return_value=mock_settings):
            with patch("src.alerting.telegram.get_settings", return_value=mock_settings):
                with patch("src.alerting.email.get_settings", return_value=mock_settings):
                    yield mock_settings

    @pytest.fixture
    def mock_session(self):
        """Mock de la session SQLAlchemy."""
        session = AsyncMock()
        return session

    @pytest.fixture
    def dispatcher(self, mock_settings, mock_session):
        """Crée une instance du dispatcher."""
        from src.alerting.dispatcher import NotificationDispatcher
        return NotificationDispatcher(mock_session)

    def test_initialization(self, dispatcher):
        """Test de l'initialisation."""
        assert dispatcher._telegram is not None
        assert dispatcher._email is not None
        assert dispatcher._results == []

    @pytest.mark.asyncio
    async def test_test_channels(self, dispatcher, mock_settings):
        """Test de la vérification des canaux."""
        # Mock les méthodes de test
        dispatcher._telegram.send_test_message = AsyncMock(return_value=True)
        dispatcher._email.send_test_email = AsyncMock(return_value=True)

        results = await dispatcher.test_channels()

        assert "telegram" in results
        assert "email" in results

    def test_get_results_empty(self, dispatcher):
        """Test des résultats vides."""
        results = dispatcher.get_results()
        assert results == []

    def test_clear_results(self, dispatcher):
        """Test de l'effacement des résultats."""
        from src.alerting.dispatcher import NotificationResult

        dispatcher._results.append(
            NotificationResult(channel="test", success=True, alert_id="1")
        )

        dispatcher.clear_results()
        assert dispatcher._results == []
