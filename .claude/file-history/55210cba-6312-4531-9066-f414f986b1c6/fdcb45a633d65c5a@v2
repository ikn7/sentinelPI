"""Dashboard Streamlit pour StratWatch."""

import asyncio
from datetime import date, datetime, timedelta

import streamlit as st

# Configuration de la page
st.set_page_config(
    page_title="StratWatch - Veille StratÃ©gique",
    page_icon="ğŸ“Š",
    layout="wide",
    initial_sidebar_state="expanded",
)


# =============================================================================
# Fonctions utilitaires async
# =============================================================================

def run_async(coro):
    """ExÃ©cute une coroutine de maniÃ¨re synchrone."""
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    try:
        return loop.run_until_complete(coro)
    finally:
        loop.close()


async def get_db_session():
    """Initialise et retourne une session de base de donnÃ©es."""
    from src.storage import db
    if not db.is_initialized:
        await db.init()
        await db.create_tables()
    return db


# =============================================================================
# Fonctions de donnÃ©es
# =============================================================================

async def load_stats():
    """Charge les statistiques globales."""
    from sqlalchemy import func, select
    from src.storage.models import Alert, Competitor, JobOffer, Regulation

    db = await get_db_session()
    async with db.session() as session:
        competitors = await session.execute(
            select(func.count(Competitor.id)).where(Competitor.actif == True)
        )
        alerts_unread = await session.execute(
            select(func.count(Alert.id)).where(Alert.read_at == None)
        )
        alerts_critical = await session.execute(
            select(func.count(Alert.id)).where(
                Alert.read_at == None,
                Alert.severite == "critique"
            )
        )
        regulations = await session.execute(select(func.count(Regulation.id)))
        jobs = await session.execute(
            select(func.count(JobOffer.id)).where(JobOffer.active == True)
        )

        return {
            "competitors": competitors.scalar() or 0,
            "alerts_unread": alerts_unread.scalar() or 0,
            "alerts_critical": alerts_critical.scalar() or 0,
            "regulations": regulations.scalar() or 0,
            "job_offers": jobs.scalar() or 0,
        }


async def load_recent_alerts(limit: int = 10):
    """Charge les alertes rÃ©centes."""
    from sqlalchemy import select
    from src.storage.models import Alert, Competitor

    db = await get_db_session()
    async with db.session() as session:
        result = await session.execute(
            select(Alert)
            .order_by(Alert.created_at.desc())
            .limit(limit)
        )

        alerts = []
        for alert in result.scalars():
            competitor_name = None
            if alert.competitor_id:
                comp = await session.execute(
                    select(Competitor.nom).where(Competitor.id == alert.competitor_id)
                )
                competitor_name = comp.scalar()

            alerts.append({
                "id": alert.id,
                "type": alert.type,
                "categorie": alert.categorie,
                "severite": alert.severite,
                "titre": alert.titre,
                "message": alert.message,
                "competitor": competitor_name,
                "created_at": alert.created_at,
                "read": alert.read_at is not None,
            })

        return alerts


async def load_competitors():
    """Charge la liste des concurrents."""
    from sqlalchemy import select
    from src.storage.models import Competitor

    db = await get_db_session()
    async with db.session() as session:
        result = await session.execute(
            select(Competitor)
            .where(Competitor.actif == True)
            .order_by(Competitor.priorite, Competitor.nom)
        )
        return list(result.scalars().all())


async def load_competitor_detail(competitor_id: str):
    """Charge les dÃ©tails d'un concurrent."""
    from sqlalchemy import func, select
    from src.storage.models import (
        Competitor, Dirigeant, Financial, JobOffer,
        Alert, NewsMention, BodaccAnnouncement
    )

    db = await get_db_session()
    async with db.session() as session:
        result = await session.execute(
            select(Competitor).where(Competitor.id == competitor_id)
        )
        competitor = result.scalar_one_or_none()

        if not competitor:
            return None

        # Dirigeants
        dirigeants = await session.execute(
            select(Dirigeant).where(
                Dirigeant.competitor_id == competitor_id,
                Dirigeant.actif == True
            )
        )

        # Finances
        financials = await session.execute(
            select(Financial)
            .where(Financial.competitor_id == competitor_id)
            .order_by(Financial.annee.desc())
        )

        # Offres rÃ©centes
        jobs = await session.execute(
            select(JobOffer)
            .where(JobOffer.competitor_id == competitor_id, JobOffer.active == True)
            .order_by(JobOffer.date_detection.desc())
            .limit(10)
        )

        # Alertes rÃ©centes
        alerts = await session.execute(
            select(Alert)
            .where(Alert.competitor_id == competitor_id)
            .order_by(Alert.created_at.desc())
            .limit(5)
        )

        return {
            "competitor": competitor,
            "dirigeants": list(dirigeants.scalars().all()),
            "financials": list(financials.scalars().all()),
            "jobs": list(jobs.scalars().all()),
            "alerts": list(alerts.scalars().all()),
        }


async def load_regulations(limit: int = 20):
    """Charge les rÃ©glementations rÃ©centes."""
    from sqlalchemy import select
    from src.storage.models import Regulation

    db = await get_db_session()
    async with db.session() as session:
        result = await session.execute(
            select(Regulation)
            .order_by(Regulation.date_publication.desc())
            .limit(limit)
        )
        return list(result.scalars().all())


async def load_deadlines(days: int = 30):
    """Charge les Ã©chÃ©ances Ã  venir."""
    from sqlalchemy import select
    from src.storage.models import Regulation, RegulationDeadline

    db = await get_db_session()
    async with db.session() as session:
        today = date.today()
        result = await session.execute(
            select(RegulationDeadline, Regulation.titre)
            .join(Regulation)
            .where(
                RegulationDeadline.date_echeance >= today,
                RegulationDeadline.date_echeance <= today + timedelta(days=days)
            )
            .order_by(RegulationDeadline.date_echeance)
        )
        return [(d, t) for d, t in result.all()]


# =============================================================================
# Interface utilisateur
# =============================================================================

def render_sidebar():
    """Affiche la barre latÃ©rale."""
    with st.sidebar:
        st.title("ğŸ“Š StratWatch")
        st.caption("Veille stratÃ©gique")

        st.divider()

        page = st.radio(
            "Navigation",
            ["ğŸ  Dashboard", "ğŸ¢ Concurrents", "ğŸ“œ RÃ©glementation", "ğŸ”” Alertes"],
            label_visibility="collapsed",
        )

        st.divider()

        # Bouton de rafraÃ®chissement
        if st.button("ğŸ”„ RafraÃ®chir", use_container_width=True):
            st.cache_data.clear()
            st.rerun()

        st.divider()

        st.caption("StratWatch v1.0.0")

        return page


def render_dashboard():
    """Affiche la page dashboard."""
    st.title("ğŸ  Dashboard")

    # Statistiques
    stats = run_async(load_stats())

    col1, col2, col3, col4, col5 = st.columns(5)

    with col1:
        st.metric("Concurrents", stats["competitors"])
    with col2:
        st.metric("Alertes non lues", stats["alerts_unread"])
    with col3:
        st.metric("Alertes critiques", stats["alerts_critical"], delta_color="inverse")
    with col4:
        st.metric("RÃ©glementations", stats["regulations"])
    with col5:
        st.metric("Offres d'emploi", stats["job_offers"])

    st.divider()

    # Deux colonnes
    col_left, col_right = st.columns([2, 1])

    with col_left:
        st.subheader("ğŸ”” Alertes rÃ©centes")
        alerts = run_async(load_recent_alerts(10))

        if not alerts:
            st.info("Aucune alerte")
        else:
            for alert in alerts:
                severity_colors = {
                    "critique": "ğŸ”´",
                    "important": "ğŸŸ ",
                    "attention": "ğŸŸ¡",
                    "info": "ğŸ”µ",
                }
                icon = severity_colors.get(alert["severite"], "âšª")
                read_icon = "" if alert["read"] else " ğŸ†•"

                with st.expander(f"{icon} {alert['titre']}{read_icon}"):
                    st.write(alert["message"])
                    if alert["competitor"]:
                        st.caption(f"ğŸ¢ {alert['competitor']}")
                    st.caption(f"ğŸ“… {alert['created_at'].strftime('%d/%m/%Y %H:%M')}")

    with col_right:
        st.subheader("â° Ã‰chÃ©ances Ã  venir")
        deadlines = run_async(load_deadlines(30))

        if not deadlines:
            st.info("Aucune Ã©chÃ©ance dans les 30 prochains jours")
        else:
            for deadline, titre in deadlines[:5]:
                days_until = (deadline.date_echeance - date.today()).days

                if days_until <= 7:
                    color = "red"
                elif days_until <= 14:
                    color = "orange"
                else:
                    color = "green"

                st.markdown(f":{color}[**{days_until}j**] {deadline.description[:50]}")
                st.caption(titre[:60] + "..." if len(titre) > 60 else titre)


def render_competitors():
    """Affiche la page des concurrents."""
    st.title("ğŸ¢ Concurrents")

    competitors = run_async(load_competitors())

    if not competitors:
        st.info("Aucun concurrent configurÃ©")
        st.markdown("""
        Pour ajouter des concurrents, Ã©ditez le fichier `config/competitors.yaml`
        ou utilisez la commande:
        ```bash
        stratwatch collect search "nom entreprise"
        ```
        """)
        return

    # SÃ©lection du concurrent
    competitor_names = {c.nom: c.id for c in competitors}
    selected_name = st.selectbox(
        "SÃ©lectionner un concurrent",
        options=list(competitor_names.keys()),
    )

    if selected_name:
        competitor_id = competitor_names[selected_name]
        data = run_async(load_competitor_detail(competitor_id))

        if data:
            comp = data["competitor"]

            # Informations gÃ©nÃ©rales
            col1, col2 = st.columns(2)

            with col1:
                st.subheader("ğŸ“‹ Informations")
                st.write(f"**SIREN:** {comp.siren}")
                st.write(f"**Forme juridique:** {comp.forme_juridique or 'N/A'}")
                st.write(f"**Code NAF:** {comp.code_naf or 'N/A'}")
                if comp.capital_social:
                    st.write(f"**Capital:** {comp.capital_social:,} â‚¬".replace(",", " "))
                if comp.site_web:
                    st.write(f"**Site web:** [{comp.site_web}]({comp.site_web})")

            with col2:
                st.subheader("ğŸ‘¥ Dirigeants")
                if data["dirigeants"]:
                    for d in data["dirigeants"]:
                        name = f"{d.prenom or ''} {d.nom}".strip()
                        st.write(f"â€¢ **{name}** - {d.fonction}")
                else:
                    st.info("Aucun dirigeant enregistrÃ©")

            st.divider()

            # DonnÃ©es financiÃ¨res
            if data["financials"]:
                st.subheader("ğŸ’° DonnÃ©es financiÃ¨res")
                fin_data = []
                for f in data["financials"][:5]:
                    fin_data.append({
                        "AnnÃ©e": f.annee,
                        "CA (â‚¬)": f"{f.chiffre_affaires:,}".replace(",", " ") if f.chiffre_affaires else "N/A",
                        "RÃ©sultat (â‚¬)": f"{f.resultat_net:,}".replace(",", " ") if f.resultat_net else "N/A",
                        "Effectif": f.effectif or "N/A",
                    })
                st.table(fin_data)

            # Offres d'emploi
            st.subheader("ğŸ’¼ Offres d'emploi rÃ©centes")
            if data["jobs"]:
                for job in data["jobs"][:5]:
                    st.write(f"â€¢ [{job.titre}]({job.url}) - {job.source}")
            else:
                st.info("Aucune offre d'emploi")

            # Alertes
            st.subheader("ğŸ”” Alertes rÃ©centes")
            if data["alerts"]:
                for alert in data["alerts"]:
                    st.write(f"â€¢ **[{alert.severite.upper()}]** {alert.titre}")
            else:
                st.info("Aucune alerte")


def render_regulations():
    """Affiche la page rÃ©glementation."""
    st.title("ğŸ“œ RÃ©glementation")

    tab1, tab2 = st.tabs(["ğŸ“° Textes rÃ©cents", "â° Ã‰chÃ©ances"])

    with tab1:
        regulations = run_async(load_regulations(30))

        if not regulations:
            st.info("Aucune rÃ©glementation collectÃ©e")
        else:
            for reg in regulations:
                type_icons = {
                    "loi": "ğŸ“•",
                    "decret": "ğŸ“—",
                    "arrete": "ğŸ“˜",
                    "ordonnance": "ğŸ“™",
                }
                icon = type_icons.get(reg.type, "ğŸ“„")
                titre = reg.titre_court or reg.titre[:80]

                with st.expander(f"{icon} {titre}"):
                    st.write(f"**Type:** {reg.type}")
                    if reg.numero:
                        st.write(f"**NumÃ©ro:** {reg.numero}")
                    if reg.date_publication:
                        st.write(f"**Publication:** {reg.date_publication.strftime('%d/%m/%Y')}")
                    if reg.resume:
                        st.write(reg.resume[:500])
                    st.markdown(f"[Voir le texte complet]({reg.url})")

    with tab2:
        days = st.slider("Horizon (jours)", 7, 90, 30)
        deadlines = run_async(load_deadlines(days))

        if not deadlines:
            st.info(f"Aucune Ã©chÃ©ance dans les {days} prochains jours")
        else:
            for deadline, titre in deadlines:
                days_until = (deadline.date_echeance - date.today()).days

                if days_until <= 7:
                    st.error(f"âš ï¸ **{days_until} jours** - {deadline.description}")
                elif days_until <= 14:
                    st.warning(f"â³ **{days_until} jours** - {deadline.description}")
                else:
                    st.info(f"ğŸ“… **{days_until} jours** - {deadline.description}")

                st.caption(titre[:80])
                st.divider()


def render_alerts():
    """Affiche la page des alertes."""
    st.title("ğŸ”” Alertes")

    # Filtres
    col1, col2, col3 = st.columns(3)
    with col1:
        category_filter = st.selectbox(
            "CatÃ©gorie",
            ["Toutes", "concurrent", "reglementaire", "croisee"],
        )
    with col2:
        severity_filter = st.selectbox(
            "SÃ©vÃ©ritÃ©",
            ["Toutes", "critique", "important", "attention", "info"],
        )
    with col3:
        show_read = st.checkbox("Inclure les lues", value=False)

    # Charger les alertes
    alerts = run_async(load_recent_alerts(50))

    # Appliquer les filtres
    if category_filter != "Toutes":
        alerts = [a for a in alerts if a["categorie"] == category_filter]
    if severity_filter != "Toutes":
        alerts = [a for a in alerts if a["severite"] == severity_filter]
    if not show_read:
        alerts = [a for a in alerts if not a["read"]]

    # Afficher
    st.caption(f"{len(alerts)} alerte(s)")

    if not alerts:
        st.success("ğŸ‰ Aucune alerte non lue!")
    else:
        for alert in alerts:
            severity_colors = {
                "critique": "ğŸ”´",
                "important": "ğŸŸ ",
                "attention": "ğŸŸ¡",
                "info": "ğŸ”µ",
            }
            icon = severity_colors.get(alert["severite"], "âšª")
            read_badge = " âœ“" if alert["read"] else ""

            with st.container():
                st.markdown(f"### {icon} {alert['titre']}{read_badge}")
                st.write(alert["message"])

                cols = st.columns(4)
                with cols[0]:
                    st.caption(f"ğŸ“ {alert['categorie']}")
                with cols[1]:
                    st.caption(f"âš¡ {alert['severite']}")
                with cols[2]:
                    if alert["competitor"]:
                        st.caption(f"ğŸ¢ {alert['competitor']}")
                with cols[3]:
                    st.caption(f"ğŸ“… {alert['created_at'].strftime('%d/%m %H:%M')}")

                st.divider()


# =============================================================================
# Main
# =============================================================================

def main():
    """Point d'entrÃ©e principal."""
    page = render_sidebar()

    if page == "ğŸ  Dashboard":
        render_dashboard()
    elif page == "ğŸ¢ Concurrents":
        render_competitors()
    elif page == "ğŸ“œ RÃ©glementation":
        render_regulations()
    elif page == "ğŸ”” Alertes":
        render_alerts()


if __name__ == "__main__":
    main()
